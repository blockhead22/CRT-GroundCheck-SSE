name: Phase 6 Boundary Enforcement

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  phase-6-enforcement:
    name: Phase 6 Boundary Violation Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Phase 6 Boundary Tests
      run: |
        pytest tests/test_phase_6_boundary_violations.py -v --tb=short
      continue-on-error: false
    
    - name: Verify all 24 tests passed
      run: |
        pytest tests/test_phase_6_boundary_violations.py --tb=no -q | grep "24 passed"
    
    - name: Check for forbidden patterns in diff
      if: github.event_name == 'pull_request'
      run: |
        echo "Checking for Phase D violation patterns..."
        git fetch origin main
        
        # Search for outcome measurement patterns
        if git diff origin/main...HEAD | grep -iE "(measure.*outcome|track.*feedback|was.*helpful|engagement.*metric|success_rate)"; then
          echo "❌ PHASE D VIOLATION: Outcome measurement detected in diff"
          exit 1
        fi
        
        # Search for learning patterns
        if git diff origin/main...HEAD | grep -iE "(learn_from|adapt_to|improve.*recommendation|trending|popular)"; then
          echo "❌ LEARNING VIOLATION: Learning mechanism detected in diff"
          exit 1
        fi
        
        # Search for state persistence patterns
        if git diff origin/main...HEAD | grep -iE "(save_session|persist.*state|remember.*user|user_profile)"; then
          echo "❌ STATE VIOLATION: State persistence detected in diff"
          exit 1
        fi
        
        echo "✅ No obvious Phase D violation patterns in diff"
    
    - name: Report enforcement status
      if: success()
      run: |
        echo "✅ Phase 6 Boundary Enforcement: PASSED"
        echo "  - All 24 tests passed"
        echo "  - No outcome measurement detected"
        echo "  - No learning mechanisms detected"
        echo "  - No state persistence detected"
        echo "  - System remains stateless"
        echo ""
        echo "This PR is compatible with Phase 6 boundaries."
    
    - name: Report violation
      if: failure()
      run: |
        echo "❌ Phase 6 Boundary Enforcement: FAILED"
        echo ""
        echo "This PR introduces boundary violations."
        echo "See test output above for details."
        echo ""
        echo "Phase 6 violations cannot be merged."
        echo "Review CODE_REVIEW_CHECKLIST.md for guidance."
        exit 1
